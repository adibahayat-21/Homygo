1Ô∏è‚É£ Schema & Data

Tumne apne listing schema me geometry field add ki:

geometry: {
  type: { type: String, enum: ['Point'], required: true },
  coordinates: { type: [Number], required: true }
}


Jab new listing create hoti hai, usme location aur country enter karte ho.

2Ô∏è‚É£ Geocoding: Location ‚Üí Coordinates

getCoordinates function bana ke OpenStreetMap Nominatim API call kiya:

async function getCoordinates(location, country) {
  const response = await axios.get('https://nominatim.openstreetmap.org/search', {
    params: { q: `${location},${country}`, format:'json', limit:1 }
  });
  if(response.data.length>0){
      return { latitude: parseFloat(response.data[0].lat), longitude: parseFloat(response.data[0].lon) };
  }
  return null;
}


Ye function latitude/longitude return karta hai.

Jab new listing save hoti hai, coordinates geometry.coordinates = [lon, lat] me store hote hai.

3Ô∏è‚É£ Backend ‚Üí Frontend Passing

show_listing route me:

res.render("show.ejs", { data });


show.ejs me coordinates ko JS me pass kiya:

<script>
  window.coordinates = <%= JSON.stringify(data.geometry ? data.geometry.coordinates.map(Number) : [77.4126, 23.2599]) %>;
</script>


Default coordinates Bhopal [77.4126, 23.2599] rakhi agar geometry missing ho.

4Ô∏è‚É£ Frontend Map (MapLibre)

map.js me:

const coords = [Number(window.coordinates[0]), Number(window.coordinates[1])];

const map = new maplibregl.Map({
  container: 'map',
  style: 'https://demotiles.maplibre.org/style.json', // free OSM tiles
  center: coords,
  zoom: 12
});

new maplibregl.Marker()
  .setLngLat(coords)
  .addTo(map);


‚úÖ center aur marker dono same coordinates me set.

window.coordinates ko number me convert kiya [Number(lng), Number(lat)].

5Ô∏è‚É£ Map Styling

CSS me .map-wrapper aur #map ko modern card-style, shadow, rounded corners, gradient background diya.

6Ô∏è‚É£ Old Listings Update (Optional)

updateOldListings.js file bana ke purani listings jisme geometry nahi thi unke liye coordinates fetch kiye OpenStreetMap se aur save kiye.

üîπ Flow Summary

Form Submission: User enters location + country.

Backend: getCoordinates() ‚Üí returns [lon, lat].

Save to DB: Store in geometry.coordinates.

Show Page (show.ejs): Pass geometry.coordinates to JS (window.coordinates).

Frontend Map (map.js):

Convert coordinates to number.

Initialize MapLibre map with center and zoom.

Place marker at coordinates.

CSS: Style map wrapper & heading for modern look.

DB se data fetch ‚Üí

res.render me pass ‚Üí

EJS me access ‚Üí

JS me coordinates read karke Map me set